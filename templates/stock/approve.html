{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load humanize %}
{% load extras %}

{% block content %}
	<!--
	<div class="navigation">
		<span class="navigation-item">1.Cart</span>
		<span class="navigation-item">2.Approve</span>
		<span class="navigation-item">3.Order</span>
	</div>
	-->

	<div class="container my-5">
		<div class="modal fade" tabindex="-1" role="dialog" id="modal" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content"></div>
			</div>
		</div>
		<div class="row page-title">
			<h2 class="title-text">依頼内容確認・変更画面</h2>
		</div>
		<div class="row mt-5">
			<div class="col-9">
				<div class="row approve-menu">
					<div class="col-3">
						<span class="menu-title">1 依頼者情報</span>
					</div>
					<div class="col-8">
						<p>{{ request.user.screenname }}</p>
						<p>{{ request.user.department }}</p>
					</div>
				</div>
				<div class="row approve-menu mt-2">
					<div class="col-3">
						<span class="menu-title">2 承認者情報</span>
					</div>
					{% if approve is not None%}
						<div class="col-8">
							<p>{{ approve }}</p>
							<p>部門コード：{{ approve.dept_code }}</p>
							<p>部門名：{{ approve.dept_name }}</p>
						</div>
						<div class="col-1">
							<a href="#" class="update-approve">変更</a>
						</div>
					{% else %}
						<div class="col-8">
							<a href="#" class="create-approve">登録</a>
						</div>
					{% endif %}
				</div>
				<div class="row mt-2">
					<div class="col-4">
						<span class="menu-title">3 商品とお届け情報の確認</span>
					</div>
				</div>
				<div class="row">
					{% for order_item in cart.order_item.all %}
						<div class="card mt-3 approve-item">
							<div class="card-body">
								<div class="row">
									<p class="schedule">お届け予定日：
										<span class="schedule-date{{ order_item.pk }}">
											{% if order_item.due_at is not None %}
												{{ order_item.due_at }}
											{% else %}
												お問い合わせください
											{% endif %}
										</span>
									</p>
									<div class="col-2">
										{% if order_item.storage_item.item.pc.img.name == '' %}
	                                        <img src="/media/images/no_image_logo.png" alt="noimage" class="item-img">
	                                    {% else %}
	                                        <img src="{{ order_item.storage_item.item.pc.img.url }}" alt="{{ storage_item.item.pc.name }}" class="item-img">
	                                    {% endif %}
									</div>
									<div class="col-5">
										<p class="item-name mb-1">{{ order_item.storage_item }}</p>
										<p class="item-price mb-1">￥{{ order_item.pk | total_price | intcomma}}</p>
										<p class="mb-1">
	                                        数量：
	                                        <button type="button" class="btn btn-sm btn-secondary"
	                                                onclick="location.href='{% url "stock:reduce_cart" order_item.pk %}'">-</button>
	                                        {{ order_item.quantity }}
	                                        <button type="button" class="btn btn-sm btn-secondary"
	                                                onclick="location.href='{% url "stock:add_item" order_item.storage_item.pk %}'">+</button>
	                                    </p>
									</div>
									<div class="col-5">
										<p class="item-name">キッティングオプション</p>
										<form action="#" method="post">
											{% csrf_token %}
											{% for plan in kitting_plan %}
												<div class="form-check">
													<label for="kittingPlan{{ plan.pk }}_{{ order_item.pk }}">
														{{ plan.name }}￥{{ plan.price | intcomma }}
													</label>
													<input type="radio" class="form-check-input select-plan" id="kittingPlan{{ plan.pk }}_{{ order_item.pk }}"
													       name="kittingSelect{{ order_item.pk }}" value="{{ plan.price }}"
															{% if plan.pk == order_item.kitting_plan.pk %}
																checked
															{% endif %}>
												</div>
											{% endfor %}
										</form>
									</div>
								</div>
							</div>
						</div>
					{% endfor %}
				</div>
			</div>
			<div class="col-3">
				<div class="card approve-card">
					<div class="card-body">
						<div class="row bottom-border">
							<button type="button" class="btn btn-warning my-3" id="confirm"
							        {% if approve is None %}disabled{% endif %}>
								注文を確定
							</button>
						</div>
						<div class="row bottom-border mb-3">
							<p><span class="confirm-text">注文内容</span>(税込み)</p>
							<p class="mb-1">
								商品の小計：
								<span class="confirm-price float-end">￥{{ request.user | storage_subtotal | intcomma }}</span>
							</p>
							<p class="mb-1">
								キッティング費用：
								<span class="confirm-price float-end">￥
									<span class="total-kitting-price">{{ request.user | storage_kitting_price | intcomma }}</span>
								</span>
							</p>
						</div>
						<div class="row bottom-border mb-3">
							<p class="confirm-text total-price">
								ご請求額：
								<span class="float-end">￥{{ request.user | storage_total_price | intcomma }}</span>
							</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

{% endblock content %}

{% block javascript %}

	<script type="text/javascript">
		const confirm = document.querySelector('#confirm');
        const next_url = "{% url 'stock:add_order_info' %}"
        linkClick(confirm, next_url);

		$(function() {
            $(".create-approve").each(function () {
                $(this).modalForm({formURL: "{% url 'stock:approve_create' %}"});
            });
		});

        {% if approve is not None %}
	        $(".update-approve").each(function() {
                $(this).modalForm({formURL: "{% url 'stock:approve_update' approve.pk %}"});
	        });
        {% endif %}

		$("#modal").on('show.bs.modal', function() {
            const form = document.querySelector('form');
	        form.addEventListener("submit", event =>
		        event.target.querySelectorAll("input:disabled, select:disabled").forEach(e => e.disabled = false)
	        );
		});

        //ajax
        const kittingPrice = document.querySelector('.total-kitting-price');
        const selectPlan = document.querySelectorAll('.select-plan');
		{% for order_item in cart.order_item.all %}
			const scheduleDate{{ order_item.pk }} = document.querySelector('.schedule-date{{ order_item.pk }}');
			const url{{ order_item.pk }} = "{{ api_url }}{{ order_item.pk }}/";
            {% for plan in kitting_plan %}
                let checkId{{ plan.pk }}_{{ order_item.pk }} = '#kittingPlan{{ plan.pk }}_{{ order_item.pk }}';
                let data{{ plan.pk }}_{{ order_item.pk }} = {
                    storage_item: {{ order_item.storage_item.pk }},
                    quantity: {{ order_item.quantity }},
                    requester: {{ request.user.pk }},
                    kitting_plan: {{ plan.pk }}
                }
	            const changeRadio{{ plan.pk }}_{{ order_item.pk }} = document.querySelector(
                    checkId{{ plan.pk }}_{{ order_item.pk }}
	            );
                changeRadio{{ plan.pk }}_{{ order_item.pk }}.addEventListener('click', function() {
                    const init = makeInit(data{{ plan.pk }}_{{ order_item.pk }})
                    put(url{{ order_item.pk }}, init, scheduleDate{{ order_item.pk }});
                    changePrice(selectPlan, kittingPrice, {{ order_item.quantity }});
                });
            {% endfor %}
        {% endfor %}
        async function put(url, init, el) {
            await fetch(url, init)
	            .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw Error();
                    }
	            })
	            .then(data => {
                    const schedule = formatDate(data.due_at, 'YYYY年MM月DD日');
                    el.innerHTML = '';
                    el.innerHTML = schedule;
	            })
        }


	</script>

{% endblock javascript %}