{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load static %}
{% load humanize %}
{% load extras %}


{% block content %}

    <div class="container">
        <div class="modal fade" tabindex="-1" role="dialog" id="modal" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content"></div>
            </div>
        </div>
        <div class="row mb-3">
            <h2 class="title-text">在庫リスト</h2>
        </div>
        <div class="row mt-5">
            <div class="col-1">在庫拠点：</div>
            <div class="form-group col-1">
                <label>
                    <select title="base" name="base" class="custom-select" id="baseSelect">
                        <option value="all">すべて</option>
                        {% for base in base_list %}
                            <option value="{{ base.name }}">{{ base.name }}</option>
                        {% endfor %}
                    </select>
                </label>
            </div>
            <div class="col-4 item-list">
                <i class="fas fa-list item-table"></i>
                <i class="fas fa-table item-card ms-3"></i>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-1">カテゴリー：</div>
            <div class="form-group col-1">
                <label>
                    <select title="category" name="category" class="custom-select" id="categorySelect">
                        <option value="all">すべて</option>
                        <option value="ノートPC">ノートPC</option>
                        <option value="デスクトップPC">デスクトップPC</option>
                        <option value="ミニPC">ミニPC</option>
                    </select>
                </label>
            </div>
        </div>
        <div class="row" id="storageTable" style="display: none;">
            <div class="storage-table">
                <table class="table table-bordered small mt-5">
                    <thead class="table-light">
                        <tr>
                            <th>発注番号</th>
                            <th>カテゴリー</th>
                            <th>メーカー</th>
                            <th>モデル名</th>
                            <th>CPU</th>
                            <th>メモリ</th>
                            <th>ストレージ</th>
                            <th>テンキー</th>
                            <th>在庫数</th>
                            <th>金額</th>
                            <th>在庫拠点</th>
                            <th>詳細</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for storageitem in storageitem_list %}
                        <tr id="table{{ storageitem.pk }}">
                            <td>{{ storageitem.order_number }}</td>
                            <td id="category{{ storageitem.pk }}">{{ storageitem.item.pc.get_category_display }}</td>
                            <td>{{ storageitem.item.pc.maker }}</td>
                            <td>{{ storageitem.item.pc.name }}</td>
                            <td>{{ storageitem.item.cpu }}</td>
                            <td>{{ storageitem.item.memory }}GB</td>
                            <td>{{ storageitem.item.storage }}</td>
                            <td>
                                {% if storageitem.item.numpad %}
                                    <input class="form-check-input" type="checkbox" id="numpad" aria-label="{{ storageitem.item.pc.name }}" checked disabled>
                                {% else %}
                                    {{ storageitem.item.numpad | boolean_check }}
                                {% endif %}
                            </td>
                            <td>{{ storageitem.quantity }}</td>
                            <td>{{ storageitem.total_price | intcomma }}</td>
                            <td id="base{{ storageitem.pk }}">{{ storageitem.base }}</td>
                            <td>
                                <a href="{% url 'stock:storage_detail'  storageitem.pk %}">詳細</a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="11">在庫PCないです</td>
                        </tr>
                    {% endfor %}
                        <tr id="nonStorage" style="display: none;">
                            <td colspan="11">在庫ないです</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- カード表示 -->
        <div class="row" id="storageCard">
            {% for storageitem in storageitem_list %}
                <div class="col-4 mt-5 storage-card" id="card{{ storageitem.pk }}">
                    <div class="card">
                        <div class="card-body px-4 py-5">
                            {% if storageitem.item.pc.img.name == '' %}
                                <img src="/media/images/no_image_logo.png" alt="noimage" class="image-fluid card-img-cart">
                            {% else %}
                                <img src="{{ storageitem.item.pc.img.url }}" alt="{{ storageitem.item.pc.name }}" class="image-fluid card-img-cart">
                            {% endif %}
                            <h5 class="card-title">{{ storageitem.item.pc.maker }}</h5>
                            <h5 class="card-subtitle">{{ storageitem.item.pc.name }}</h5>
                            <p class="mb-1 mt-3" id="category{{ storage.pk }}">カテゴリー：{{ storageitem.item.pc.get_category_display }}</p>
                            <p class="mb-1">メモリ：{{ storageitem.item.memory }} GB</p>
                            <p class="mb-1">ストレージ：{{ storageitem.item.storage }}</p>
                            <p class="mb-1">テンキー：
                                {% if storageitem.item.numpad %}
                                    <input class="form-check-input" type="checkbox" id="numpad" aria-label="{{ storage.item.pc.name }}" checked disabled>
                                {% else %}
                                    {{ storageitem.item.numpad | boolean_check }}
                                {% endif %}
                            </p>
                            <p class="mb-1">在庫数：{{ storageitem.quantity }}</p>
                            <p class="mb-1" id="base{{ storage.pk }}">在庫拠点：{{ storageitem.base }}</p>
                            <p class="mb-1">合計金額：{{ storageitem.total_price }}円</p>
                        </div>
                        <div class="card-footer">
                            <a href="{% url 'stock:storage_detail' storageitem.pk %}" class="card-link">
                                詳細
                            </a>
                            <a href="#" class="btn btn-outline-primary float-end">
                                <i class="fas fa-cart-arrow-down">確保依頼する</i>
                            </a>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-12">
                    なにも登録されてません
                </div>
            {% endfor %}
        </div>
    </div>

{% endblock content %}

{% block javascript %}

    <script type="text/javascript">
        $(function() {
            $('#baseSelect').change(function() {
                let val = $(this).val();
                let categorySelect = $('#categorySelect').val();
                {% for storageitem in storageitem_list %}
                    let base_{{ storageitem.pk }} = document.getElementById('base{{ storageitem.pk }}');
                    let base_val_{{ storageitem.pk }} = base_{{ storageitem.pk }}.textContent;
                    let category{{ storageitem.pk }} = document.getElementById('category{{ storageitem.pk }}');
                    let category_val{{ storageitem.pk }} = category{{ storageitem.pk }}.textContent;
                    if (categorySelect === category_val{{ storageitem.pk }}) {
                       if (val === base_val_{{ storageitem.pk }}) {
                            $('#table{{ storageitem.pk }}').show();
                            $('#card{{ storageitem.pk }}').show();
                        } else if (val === 'all') {
                            $('#table{{ storageitem.pk }}').show();
                            $('#card{{ storageitem.pk }}').show();
                        } else {
                            $('#table{{ storageitem.pk }}').hide();
                            $('#card{{ storageitem.pk }}').hide();
                        }
                    } else if (categorySelect === 'all'){
                        if (val === base_val_{{ storageitem.pk }}) {
                            $('#table{{ storageitem.pk }}').show();
                            $('#card{{ storageitem.pk }}').show();
                        } else if (val === 'all') {
                            $('#table{{ storageitem.pk }}').show();
                            $('#card{{ storageitem.pk }}').show();
                        } else {
                            $('#table{{ storageitem.pk }}').hide();
                            $('#card{{ storageitem.pk }}').hide();
                        }
                    } else {
                        $('#table{{ storageitem.pk }}').hide();
                        $('#card{{ storageitem.pk }}').hide();
                    }
                {% endfor %}
            });
        });

        $(function() {
            $('#categorySelect').change(function() {
                let val = $(this).val();
                let baseSelect = $('#baseSelect').val();
                {% for storageitem in storageitem_list %}
                    let category{{ storageitem.pk }} = document.getElementById('category{{ storageitem.pk }}');
                    let category_val{{ storageitem.pk }} = category{{ storageitem.pk }}.textContent;
                    let base_{{ storageitem.pk }} = document.getElementById('base{{ storageitem.pk }}');
                    let base_val_{{ storageitem.pk }} = base_{{ storageitem.pk }}.textContent;
                    if (baseSelect === base_val_{{ storageitem.pk }}) {
                        if (val === category_val{{ storageitem.pk }}) {
                            $('#table{{ storageitem.pk }}').show();
                            $('#card{{ storageitem.pk }}').show();
                        } else if(val === 'all') {
                            $('#table{{ storageitem.pk }}').show();
                            $('#card{{ storageitem.pk }}').show();
                        }else {
                            $('#table{{ storageitem.pk }}').hide();
                            $('#card{{ storageitem.pk }}').hide();
                        }
                    } else if (baseSelect === 'all') {
                        if (val === category_val{{ storageitem.pk }}) {
                            $('#table{{ storageitem.pk }}').show();
                            $('#card{{ storageitem.pk }}').show();
                        } else if(val === 'all') {
                            $('#table{{ storageitem.pk }}').show();
                            $('#card{{ storageitem.pk }}').show();
                        }else {
                            $('#table{{ storageitem.pk }}').hide();
                            $('#card{{ storageitem.pk }}').hide();
                        }
                    } else {
                        $('#table{{ storageitem.pk }}').hide();
                        $('#card{{ storageitem.pk }}').hide();
                    }
                {% endfor %}
            });
        });

        let listBtn = document.getElementsByClassName('item-table')[0];
        let cardBtn = document.getElementsByClassName('item-card')[0];
        let storageTable = document.getElementById('storageTable');
        let storageCard = document.getElementById('storageCard');

        let changeTable = (table, card) => {
            table.style.display = '';
            card.style.display = 'none';
        }

        let changeCard = (table, card) => {
            table.style.display = 'none';
            card.style.display = '';
        }

        listBtn.addEventListener('click', ()=> {
            changeTable(storageTable, storageCard);
        }, false);

        cardBtn.addEventListener('click', ()=> {
            changeCard(storageTable, storageCard);
        }, false);

    </script>

{% endblock javascript %}